# Telegram Bot для управления подписками

Этот бот предназначен для управления подписками на сервис. Он позволяет пользователям оформлять подписки, управлять ими, получать уведомления о статусе подписки и чеки за оплату.

## Функциональность

- Оформление подписки через Telegram Payments
- Управление подпиской (просмотр, отмена)
- Получение чеков за оплату
- Уведомления о скором истечении подписки
- Автоматическая деактивация истекших подписок
- Панель администратора для мониторинга

## Технологии

- Node.js
- Telegraf (фреймворк для Telegram Bot API)
- PostgreSQL (база данных)
- Express (для обработки вебхуков)
- Winston (логирование)
- Node-cron (планировщик задач)
- Docker и Docker Compose (для развертывания)

## Установка и запуск

### Предварительные требования

- Node.js (версия 16 или выше)
- PostgreSQL (версия 12 или выше)
- Зарегистрированный бот в Telegram через @BotFather
- Настроенные платежи в Telegram через @BotFather и Stripe/Sberbank/Yookassa
- Docker и Docker Compose (для развертывания в контейнерах)

### Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/yourusername/ra-app-bot.git
   cd ra-app-bot
   ```

2. Установите зависимости:
   ```
   npm install
   ```

3. Создайте файл `.env` на основе `.env.example` и заполните его своими данными:
   ```
   cp .env.example .env
   ```

4. Создайте базу данных в PostgreSQL:
   ```
   createdb ra_app_bot
   ```

### Запуск

#### Режим разработки

```
npm run dev
```

#### Режим продакшена

```
npm start
```

### Развертывание с использованием Docker

#### Предварительные требования

- Docker
- Docker Compose

#### Сборка и запуск

1. Создайте файл `.env` с необходимыми переменными окружения:
   ```
   # Настройки бота
   BOT_TOKEN=your_bot_token_here
   WEBHOOK_DOMAIN=https://your-domain.com
   PORT=3000
   
   # База данных
   DATABASE_URL=postgres://username:password@postgres:5432/ra_app_bot
   
   # Платежи
   PAYMENT_TOKEN=your_payment_token_here
   ```

2. Запустите сервисы с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

#### Управление сервисами

Для удобства управления сервисами можно использовать скрипт `deploy.sh`:

```
# Запуск сервисов
./deploy.sh start

# Остановка сервисов
./deploy.sh stop

# Перезапуск сервисов
./deploy.sh restart

# Обновление сервисов
./deploy.sh update

# Просмотр логов
./deploy.sh logs

# Проверка статуса сервисов
./deploy.sh status
```

### Развертывание на NAS Synology

Для развертывания на NAS Synology необходимо:

1. Установить Docker и Docker Compose на NAS
2. Скопировать файлы проекта на NAS
3. Создать файл `.env` с необходимыми переменными окружения
4. Запустить сервисы с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

## Структура проекта

```
src/
├── commands/         # Обработчики команд бота
├── config/           # Конфигурация бота
├── handlers/         # Обработчики сообщений и событий
├── middlewares/      # Промежуточные обработчики
├── services/         # Сервисы для работы с API, БД и т.д.
├── utils/            # Вспомогательные утилиты
└── index.js          # Точка входа
```

## Команды бота

- `/start` - Запуск бота и получение приветственного сообщения
- `/help` - Показать список доступных команд
- `/subscribe` - Оформить подписку
- `/profile` - Информация о профиле и подписке
- `/receipt` - Получить чек за последнюю оплату
- `/support` - Связаться с поддержкой
- `/admin` - Панель администратора (доступна только администраторам)

## Лицензия

ISC 