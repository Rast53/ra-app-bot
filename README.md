# Telegram Bot для управления подписками

Этот бот предназначен для управления подписками на сервис через Telegram. Он интегрируется с существующей базой данных PostgreSQL и позволяет пользователям оформлять подписки, управлять ими, получать уведомления о статусе подписки и чеки за оплату.

## Функциональность

- Оформление подписки через Telegram Payments
- Управление подпиской (просмотр, отмена)
- Получение чеков за оплату
- Уведомления о скором истечении подписки
- Автоматическая деактивация истекших подписок
- Панель администратора для мониторинга

## Технологии

- Node.js
- Telegraf (фреймворк для Telegram Bot API)
- PostgreSQL (интеграция с существующей базой данных)
- Express (для обработки вебхуков)
- Winston (логирование)
- Node-cron (планировщик задач)
- Docker (для сборки и развертывания)

## Установка и запуск

### Предварительные требования

- Node.js (версия 16 или выше)
- Существующая база данных PostgreSQL
- Зарегистрированный бот в Telegram через @BotFather
- Настроенные платежи в Telegram через @BotFather и Stripe/Sberbank/Yookassa
- Docker (для сборки и развертывания)

### Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/Rast53/ra-app-bot.git
   cd ra-app-bot
   ```

2. Установите зависимости:
   ```
   npm install
   ```

3. Создайте файл `.env` на основе `.env.example` и заполните его своими данными:
   ```
   cp .env.example .env
   ```

### Запуск

#### Режим разработки

```
npm run dev
```

#### Режим продакшена

```
npm start
```

### Сборка и публикация Docker-образа

Для сборки Docker-образа и публикации его в Docker Hub используйте скрипт `build-push-dockerhub.sh`:

```
./build-push-dockerhub.sh
```

### Развертывание с использованием Docker

1. Создайте файл `.env` с необходимыми переменными окружения:
   ```
   # Настройки бота
   BOT_TOKEN=your_bot_token_here
   WEBHOOK_DOMAIN=https://your-domain.com
   PORT=3000
   
   # База данных
   DATABASE_URL=postgres://username:password@postgres:5432/database_name
   
   # Платежи
   PAYMENT_TOKEN=your_payment_token_here
   
   # Администраторы
   ADMIN_IDS=123456789,987654321
   ```

2. Запустите контейнер с помощью Docker:
   ```
   docker run -d --name ra-app-bot --env-file .env rast53/ra-app-bot:latest
   ```

   Или с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

## Интеграция с существующей базой данных

Бот настроен для работы с существующей базой данных PostgreSQL. Он использует следующие таблицы:

- `users` - информация о пользователях
- `user_subscriptions` - информация о подписках пользователей
- `subscription_plans` - планы подписок
- `payments` - информация о платежах
- `receipts` - чеки за оплату

Для корректной работы бота в базе данных должны быть созданы соответствующие таблицы с необходимыми полями.

## Структура проекта

```
src/
├── commands/         # Обработчики команд бота
├── config/           # Конфигурация бота
├── handlers/         # Обработчики сообщений и событий
├── middlewares/      # Промежуточные обработчики
├── services/         # Сервисы для работы с API, БД и т.д.
├── utils/            # Вспомогательные утилиты
└── index.js          # Точка входа
```

## Команды бота

- `/start` - Запуск бота и получение приветственного сообщения
- `/help` - Показать список доступных команд
- `/subscribe` - Оформить подписку
- `/profile` - Информация о профиле и подписке
- `/receipt` - Получить чек за последнюю оплату
- `/support` - Связаться с поддержкой
- `/admin` - Панель администратора (доступна только администраторам)

## Лицензия

ISC 